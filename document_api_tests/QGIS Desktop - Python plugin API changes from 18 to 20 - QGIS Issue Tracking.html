<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- saved from url=(0076)http://hub.qgis.org/wiki/quantum-gis/Python_plugin_API_changes_from_18_to_20 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<title>QGIS Desktop - Python plugin API changes from 18 to 20 - QGIS Issue Tracking</title>
<meta name="description" content="Redmine">
<meta name="keywords" content="issue,bug,tracker">
<link rel="shortcut icon" href="http://hub.qgis.org/favicon.ico?1322140996">
<link href="./QGIS Desktop - Python plugin API changes from 18 to 20 - QGIS Issue Tracking_files/application.css" media="all" rel="stylesheet" type="text/css">

<script src="./QGIS Desktop - Python plugin API changes from 18 to 20 - QGIS Issue Tracking_files/prototype.js" type="text/javascript"></script>
<script src="./QGIS Desktop - Python plugin API changes from 18 to 20 - QGIS Issue Tracking_files/effects.js" type="text/javascript"></script>
<script src="./QGIS Desktop - Python plugin API changes from 18 to 20 - QGIS Issue Tracking_files/dragdrop.js" type="text/javascript"></script>
<script src="./QGIS Desktop - Python plugin API changes from 18 to 20 - QGIS Issue Tracking_files/controls.js" type="text/javascript"></script>
<script src="./QGIS Desktop - Python plugin API changes from 18 to 20 - QGIS Issue Tracking_files/application.js" type="text/javascript"></script>
<link href="./QGIS Desktop - Python plugin API changes from 18 to 20 - QGIS Issue Tracking_files/jstoolbar.css" media="screen" rel="stylesheet" type="text/css">
<!--[if IE]>
    <style type="text/css">
      * html body{ width: expression( document.documentElement.clientWidth < 900 ? '900px' : '100%' ); }
      body {behavior: url(/stylesheets/csshover.htc?1198879113);}
    </style>
<![endif]-->

<!-- page specific tags -->

  <link href="./QGIS Desktop - Python plugin API changes from 18 to 20 - QGIS Issue Tracking_files/scm.css" media="screen" rel="stylesheet" type="text/css">
<style type="text/css"></style></head>
<body class="theme-Qgis controller-wiki action-index">
<div id="wrapper">
<div id="wrapper2">
<div id="top-menu">
    <div id="account">
        <ul><li><a href="http://hub.qgis.org/login" class="login">Sign in</a></li></ul>    </div>
    
    <ul><li><a href="http://hub.qgis.org/" class="home">Home</a></li>
<li><a href="http://hub.qgis.org/projects" class="projects">Projects</a></li>
<li><a href="http://www.redmine.org/guide" class="help">Help</a></li></ul></div>
      
<div id="header">
    <div id="quick-search">
        <form action="http://hub.qgis.org/search/index/quantum-gis" method="get">
        <input name="wiki_pages" type="hidden" value="1">
        <a href="http://hub.qgis.org/search/index/quantum-gis" accesskey="4">Search</a>:
        <input accesskey="f" class="small" id="q" name="q" size="20" type="text">
        </form>
        
    </div>
    
    <h1><a href="http://hub.qgis.org/projects/qgis?jump=wiki" class="root">QGIS</a> » QGIS Desktop</h1>
    
    
    <div id="main-menu">
        <ul><li><a href="http://hub.qgis.org/projects/quantum-gis" class="overview">Overview</a></li>
<li><a href="http://hub.qgis.org/projects/quantum-gis/activity" class="activity">Activity</a></li>
<li><a href="http://hub.qgis.org/projects/quantum-gis/roadmap" class="roadmap">Roadmap</a></li>
<li><a href="http://hub.qgis.org/projects/quantum-gis/issues" class="issues">Issues</a></li>
<li><a href="http://hub.qgis.org/projects/quantum-gis/wiki" class="wiki selected">Wiki</a></li>
<li><a href="http://hub.qgis.org/projects/quantum-gis/repository" class="repository">Repository</a></li></ul>
    </div>
    
</div>

<div class="" id="main">
    <div id="sidebar">        
        
  
<h3>Wiki</h3>

<a href="http://hub.qgis.org/">Start page</a><br>
<a href="http://hub.qgis.org/projects/quantum-gis/wiki/Page_index">Index by title</a><br>
<a href="http://hub.qgis.org/projects/quantum-gis/wiki/Date_index">Index by date</a><br>


        
    </div>
    
    <div id="content">
				
        <div class="contextual">


<span id="watcher"></span>






<a href="http://hub.qgis.org/projects/quantum-gis/wiki/Python_plugin_API_changes_from_18_to_20/history" class="icon icon-history">History</a>
</div>





<div class="wiki">
  <h1 id="Python-plugin-API-changes-from-18-to-20">Python plugin API changes from 1.8 to 2.0<a href="http://hub.qgis.org/wiki/quantum-gis/Python_plugin_API_changes_from_18_to_20#Python-plugin-API-changes-from-18-to-20" class="wiki-anchor">¶</a></h1>


	<ul class="toc right"><li class="heading1"><a href="http://hub.qgis.org/wiki/quantum-gis/Python_plugin_API_changes_from_18_to_20#Python-plugin-API-changes-from-18-to-20">Python plugin API changes from 1.8 to 2.0</a></li>
<li class="heading2"><a href="http://hub.qgis.org/wiki/quantum-gis/Python_plugin_API_changes_from_18_to_20#SIP-API-upgrade">SIP API upgrade</a></li>
<li class="heading3"><a href="http://hub.qgis.org/wiki/quantum-gis/Python_plugin_API_changes_from_18_to_20#QVariant-removed">QVariant removed</a></li>
<li class="heading3"><a href="http://hub.qgis.org/wiki/quantum-gis/Python_plugin_API_changes_from_18_to_20#QSettings-return-type">QSettings return type</a></li>
<li class="heading3"><a href="http://hub.qgis.org/wiki/quantum-gis/Python_plugin_API_changes_from_18_to_20#Replace-QString-methods">Replace QString methods</a></li>
<li class="heading3"><a href="http://hub.qgis.org/wiki/quantum-gis/Python_plugin_API_changes_from_18_to_20#Replace-QStringList-with-list">Replace QStringList with list</a></li>
<li class="heading3"><a href="http://hub.qgis.org/wiki/quantum-gis/Python_plugin_API_changes_from_18_to_20#Remove-QVariant-calls">Remove QVariant calls</a></li>
<li class="heading3"><a href="http://hub.qgis.org/wiki/quantum-gis/Python_plugin_API_changes_from_18_to_20#Replace-QList-methods-with-python-list-function">Replace QList methods with python list function</a></li>
<li class="heading3"><a href="http://hub.qgis.org/wiki/quantum-gis/Python_plugin_API_changes_from_18_to_20#Replace-signals-with-new-style-signals-and-connections">Replace signals with new style signals and connections</a></li>
<li class="heading2"><a href="http://hub.qgis.org/wiki/quantum-gis/Python_plugin_API_changes_from_18_to_20#Vector-layer-API-changes">Vector layer API changes</a></li>
<li class="heading3"><a href="http://hub.qgis.org/wiki/quantum-gis/Python_plugin_API_changes_from_18_to_20#QgsFeatureRequest-replaces-select">QgsFeatureRequest replaces select()</a></li>
<li class="heading3"><a href="http://hub.qgis.org/wiki/quantum-gis/Python_plugin_API_changes_from_18_to_20#Gettingsetting-QgsFeature-attributes-simplified">Getting/setting QgsFeature attributes simplified</a></li>
<li class="heading2"><a href="http://hub.qgis.org/wiki/quantum-gis/Python_plugin_API_changes_from_18_to_20#Plugin-repository-and-metadata-changes">Plugin repository and metadata changes</a></li>
<li class="heading2"><a href="http://hub.qgis.org/wiki/quantum-gis/Python_plugin_API_changes_from_18_to_20#Making-a-plugin-compatible-with-all-QGIS-versions">Making a plugin compatible with all QGIS versions</a></li>
<li class="heading3"><a href="http://hub.qgis.org/wiki/quantum-gis/Python_plugin_API_changes_from_18_to_20#Testing-for-QGIS-version">Testing for QGIS version</a></li>
<li class="heading3"><a href="http://hub.qgis.org/wiki/quantum-gis/Python_plugin_API_changes_from_18_to_20#Testing-for-SIP-api-version-QGIS-2-uses-SIP-api-v2">Testing for SIP api version (QGIS 2 uses SIP api v2)</a></li>
</ul>


	<p>This page summarizes the changes needed in migrating QGIS python plugins from the 1.8 API to the 2.0 API.  The version 2.0 API has many breaking changes which plugins need to account for.</p>


	<p>It is recommended to create a new version of plugins for 2.0, rather than include conditional code to run in both 2.0 and 1.8 in all but the simplest of plugins.  Note that both QGIS and the plugin repository distinguish between 1.8 and 2.0 version plugins.  QGIS stores 2.0 plugins in a different location (~/.qgis2/python/plugins) to version 1.8, so a user can have both versions installed alongside one another.  The repository distinguishes different versions using the plugin metadata.</p>


	<p><b>Please</b> add to this if you find something missing!</p>


	<h2 id="SIP-API-upgrade">SIP API upgrade<a href="http://hub.qgis.org/wiki/quantum-gis/Python_plugin_API_changes_from_18_to_20#SIP-API-upgrade" class="wiki-anchor">¶</a></h2>


	<p>The SIP API manages the mapping between python and C++/Qt objects.  This has been upgraded to version 2.  The most significant impact of this is that there is a much tighter mapping between Qt data types and python data types - QVariant and QString are removed.  Also the "old style" signal and slot format is no longer available.</p>


	<h3 id="QVariant-removed">QVariant removed<a href="http://hub.qgis.org/wiki/quantum-gis/Python_plugin_API_changes_from_18_to_20#QVariant-removed" class="wiki-anchor">¶</a></h3>


	<p>The "QVariant" type doesn't exist anymore so any methods returning "QVariant" will be auto converted to Python types. You no longer need to convert the return type using the "toXXXX" methods.</p>


	<p>Remove all:</p>


<pre><code class="Python syntaxhl"><span class="CodeRay"><span class="no"> 1</span>   toString()
<span class="no"> 2</span>   toList()
<span class="no"> 3</span>   toInt()
<span class="no"> 4</span>   toFloat()
<span class="no"> 5</span>   toStringList()
<span class="no"> 6</span>   toByteArray()
<span class="no"> 7</span>   toPyObject()
<span class="no"> 8</span>   QVariant(..)
<span class="no"> 9</span>   QString(...)
</span></code></pre>

	<p>Note that the autoconversion to a Python type is based on the type of the QVariant, which may not be the same as the type returned by a toXXX conversion.  So new code may need to explicitly set the python type.  Note also that some of the toXXX functions return a tuple of (type, valid) to specify whether the conversion is successful.  For example:</p>


	<p>Before:</p>


<pre><code>
value,ok = variantValue.toDouble()
if not ok:
    handleError()
</code></pre>

	<p>After:</p>


<pre><code>
     # If you are really confident the variant is the type you expect, just use it
    value = variantValue 

    # Best option to ensure value has the same type as in original code
    value = float(variantValue)  

    # To handle conversion errors
    try: 
        value=float(variantValue)
    except:
        handleError()
</code></pre>

	<p><strong>Note</strong>: If you do not explicitly set the python type, then you can introduce some subtle errors where the following code assumes a specific type of value.  For example value/10 will give a different result depending on whether value is an integer or a float.</p>


	<h3 id="QSettings-return-type">QSettings return type<a href="http://hub.qgis.org/wiki/quantum-gis/Python_plugin_API_changes_from_18_to_20#QSettings-return-type" class="wiki-anchor">¶</a></h3>


	<p>The type of QSettings return values is specified in the QSettings.value() call. More info: <a class="external" href="http://pyqt.sourceforge.net/Docs/PyQt4/pyqt_qsettings.html">http://pyqt.sourceforge.net/Docs/PyQt4/pyqt_qsettings.html</a>.</p>


	<p>Before:</p>


<pre><code>
  settings.value(“/yourboolsetting”, True).toBool()
  settings.value(“/yourintsetting”, 10).toInt()[0]
  settings.value(“/yourintsetting”).toByteArray()
</code></pre>  

	<p>After:</p>


<pre><code>
  settings.value(“/yourboolsetting”, True, type=bool)
  settings.value(“/yourintsetting”, 10, type=int)
  settings.value(“/yourintsetting”, QByteArray(), type=QByteArray)
</code></pre>

	<h3 id="Replace-QString-methods">Replace QString methods<a href="http://hub.qgis.org/wiki/quantum-gis/Python_plugin_API_changes_from_18_to_20#Replace-QString-methods" class="wiki-anchor">¶</a></h3>


	<p>"QString" no longer exists in the new QGIS API.  Any methods that return a "QString" will be converted into a native Python "unicode".  All QString methods need to be replaced with equivalent native string methods.</p>


	<p>Before:</p>


<pre><code>
  yourstring.right(4)
  files.join(",")
  if yourstring.length() &gt; 4:
  if yourstring.isEmpty()
</code></pre>

	<p>After:</p>


<pre><code>
  yourstring[4:]
  ",".join(files)
  if len(yourstring) &gt; 4
  if not yourstring
</code></pre>

	<h3 id="Replace-QStringList-with-list">Replace QStringList with list<a href="http://hub.qgis.org/wiki/quantum-gis/Python_plugin_API_changes_from_18_to_20#Replace-QStringList-with-list" class="wiki-anchor">¶</a></h3>


	<p>Before:</p>


<pre><code>
  mystrings = QStringList()
</code></pre>

	<p>After:</p>


<pre><code>
  mystrings = []
</code></pre>

	<h3 id="Remove-QVariant-calls">Remove QVariant calls<a href="http://hub.qgis.org/wiki/quantum-gis/Python_plugin_API_changes_from_18_to_20#Remove-QVariant-calls" class="wiki-anchor">¶</a></h3>


	<p>The "QVariant" also doesn't exist as an instantiated type anymore - any methods returning "QVariant" will be auto converted to Python types.  However "QVariant" can still be used to access it's enum values e.g. "QVariant.Int" can set be used.</p>


	<p>Before:</p>


<pre><code>
  myvalue = QVariant(10)
  myvalue = QVariant("Hello World")
</code></pre>

	<p>After:</p>


<pre><code>
  myvalue = 10
  myvalue = "Hello World" 
</code></pre>

	<p>Note that Null QVariant values (ie values for which QVariant.IsNull() returns True) are not mapped to the python None value as you might expect.<br>Instead they return a QPyNullVariant value.  This preserves the type information of the null object.</p>


	<h3 id="Replace-QList-methods-with-python-list-function">Replace QList methods with python list function<a href="http://hub.qgis.org/wiki/quantum-gis/Python_plugin_API_changes_from_18_to_20#Replace-QList-methods-with-python-list-function" class="wiki-anchor">¶</a></h3>


	<p>Before:<br></p><pre><code>
  if files.isEmpty()
  files.count()
</code></pre><p></p>


	<p>After:<br></p><pre><code>
  if not files
  len(files)
</code></pre><p></p>


	<h3 id="Replace-signals-with-new-style-signals-and-connections">Replace signals with new style signals and connections<a href="http://hub.qgis.org/wiki/quantum-gis/Python_plugin_API_changes_from_18_to_20#Replace-signals-with-new-style-signals-and-connections" class="wiki-anchor">¶</a></h3>


	<p><strong>Emitting</strong> before:</p>


<pre><code>
  self.emit(SIGNAL("valuesChanged(const QStringList &amp;)"), self.getArguments())
</code></pre>

	<p>After:</p>


<pre><code>
  class Test():
    valuesChanged = QtCore.pyqtSignal(list)

    def yourmethod():
      self.valuesChanged.emit(self.getArguments)
</code></pre>

	<p><b>Connecting</b> before:</p>


<pre><code>
  QObject.connect(self.iface,SIGNAL('projectRead ()'),self.readSettings) 
</code></pre>

	<p>After:</p>


<pre><code>
  self.iface.projectRead.connect(self.readSettings)
</code></pre>

	<h2 id="Vector-layer-API-changes">Vector layer API changes<a href="http://hub.qgis.org/wiki/quantum-gis/Python_plugin_API_changes_from_18_to_20#Vector-layer-API-changes" class="wiki-anchor">¶</a></h2>


	<h3 id="QgsFeatureRequest-replaces-select">QgsFeatureRequest replaces select()<a href="http://hub.qgis.org/wiki/quantum-gis/Python_plugin_API_changes_from_18_to_20#QgsFeatureRequest-replaces-select" class="wiki-anchor">¶</a></h3>


	<p>In QGIS 1.8 features are selected from a vector layer by using QgsVectorLayer.select() and then loop over provider.nextFeature().  In QGIS 2.0 the selection is defined by a QgsFeatureRequest object and features are retrieved using a python iterator created by QgsVectorLayer.getFeatures(QgsFeatureRequest). The QgsFeatureRequest object is only required to add selection criteria to the request - otherwise it can be omitted and all features will be returned.</p>


	<p>Before:</p>


<pre><code>
    layer.select()
    f=QgsFeature()
    while layer.nextFeature(f):
       ....
</code></pre>

	<p>After:</p>


<pre><code>
    for f in layer.getFeatures():
       ...
</code></pre>

	<p>To add criteria to the selection you need to explicitly define a QgsFeatureRequest, for example</p>


<pre><code>
     request=QgsFeatureRequest()
     request.setFilterRect(areaOfInterest)

     for f in layer.getFeatures(request):
         ...
</code></pre>

	<p>Other criteria and be set using setSubsetOfFields and setFlags...</p>


<pre><code>
     request.setSubsetOfFields([0,2])                  # Only return selected fields
     request.setSubsetOfFields(['name','id'],layer.fields())  # More user friendly version
     request.setFlags( QgsFeatureRequest.NoGeometry )  # Don't return geometry objects
</code></pre>

	<h3 id="Gettingsetting-QgsFeature-attributes-simplified">Getting/setting QgsFeature attributes simplified<a href="http://hub.qgis.org/wiki/quantum-gis/Python_plugin_API_changes_from_18_to_20#Gettingsetting-QgsFeature-attributes-simplified" class="wiki-anchor">¶</a></h3>


	<p>Feature attributes can be get and set by index, for example</p>


	<p>Before:</p>


<pre><code>
    index = layer.fieldNameIndex(fieldname)
    layer.select()
    f = QgsFeature()
    while layer.nextFeature(inFeat):
        fieldvalue=f.attributeMap()[index].toString())
</code></pre>

	<p>After:</p>


<pre><code>
    for f in layer.getFeatures():
        fieldvalue=f[fieldname]
</code></pre>

	<p>Feature attributes can also be set by index, for example:</p>


<pre><code>
    fields=layer.fields()
    f = QgsFeature(fields)
    f['name']='Bruce'
    f['id']=42
</code></pre>

	<p><b>NOTE</b>: Do not use f=QgsFeature(layer.fields()) - this will kill QGIS.  The QgsFieldList returned by layer.fields() must have at least the same lifetime as the QgsFeature.</p>


	<h2 id="Plugin-repository-and-metadata-changes">Plugin repository and metadata changes<a href="http://hub.qgis.org/wiki/quantum-gis/Python_plugin_API_changes_from_18_to_20#Plugin-repository-and-metadata-changes" class="wiki-anchor">¶</a></h2>


	<p>The plugin should include a metadata.txt file to upload to the repository. For example:</p>


<pre><code>
name=My Plugin
description=Does useful stuff
category=Plugins
version=1.0
experimental=False
qgisMinimumVersion=2.0
author=My name
email=myemail@somewhere.com
icon=./plugin.png
</code></pre>

	<p>NOTE: There was a rumor you should include a qgisMaximumVersion tag to the metadata.txt. Normally you don't need to set it. For further details see <a href="http://hub.qgis.org/wiki/quantum-gis/Plugin_Compatibility" class="wiki-page">Plugin_Compatibility</a></p>


	<p>Plugin <i>init</i>.py file should contain only the classFactory() method, all other information is in metadata.txt. ALL other members should be deleted from <i>init</i>.py .</p>


	<h2 id="Making-a-plugin-compatible-with-all-QGIS-versions">Making a plugin compatible with all QGIS versions<a href="http://hub.qgis.org/wiki/quantum-gis/Python_plugin_API_changes_from_18_to_20#Making-a-plugin-compatible-with-all-QGIS-versions" class="wiki-anchor">¶</a></h2>


	<h3 id="Testing-for-QGIS-version">Testing for QGIS version<a href="http://hub.qgis.org/wiki/quantum-gis/Python_plugin_API_changes_from_18_to_20#Testing-for-QGIS-version" class="wiki-anchor">¶</a></h3>


<pre><code>
if QGis.QGIS_VERSION_INT &lt; 10900:
    # Use the new API style
else:
    # Use the old API style
</code></pre>

	<h3 id="Testing-for-SIP-api-version-QGIS-2-uses-SIP-api-v2">Testing for SIP api version (QGIS 2 uses SIP api v2)<a href="http://hub.qgis.org/wiki/quantum-gis/Python_plugin_API_changes_from_18_to_20#Testing-for-SIP-api-version-QGIS-2-uses-SIP-api-v2" class="wiki-anchor">¶</a></h3>


<pre><code>
import sip
if sip.getapi("QVariant") &gt; 1:
    # Use the new API style
else:
    # Use the old API style
</code></pre>

	<p><strong>Note: This is not a recommend pattern except for small plugins as it will make your code complicated to read and maintain.</strong></p>
</div>














        
				<div style="clear:both;"></div>
    </div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
	
<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="http://www.redmine.org/">Redmine</a> © 2006-2010 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>



</body></html>